name: CI

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  api-build-and-test:
    name: API Build & Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg18
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/app
      RUST_LOG: debug
      SQLX_OFFLINE: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry & build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: |
          cargo install sqlx-cli \
            --no-default-features \
            --features rustls,postgres \
            --locked

      - name: Run database migrations
        run: sqlx migrate run
        working-directory: ./api # adjust to your API directory

      - name: Run tests
        run: cargo test --workspace
        working-directory: ./api # adjust to your API directory

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json # adjust path

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend # adjust to your frontend directory

      - name: Build
        run: npm run build
        working-directory: ./frontend # adjust to your frontend directory

  # Optional: Docker build check to ensure production images still build
  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    needs: [api-build-and-test, frontend-build]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('**/Dockerfile*', '**/Cargo.lock', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create .env.dev for Docker Compose
        run: |
          cat <<EOF > .env.dev
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=app
          DATABASE_URL=postgres://postgres:postgres@postgres:5432/app
          RUST_LOG=debug
          EOF

      - name: Build containers (no push)
        run: |
          DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 \
          docker compose -f docker-compose.dev.yml build
